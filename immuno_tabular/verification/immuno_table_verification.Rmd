---
title: "CoVPN COVID-19 Vaccine Efficacy Trial Immunogenicity Report - Verification"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
  pdf_document:
    df_print: kable
    toc: yes
    toc_depth: 2
classoption: landscape
header-includes: \usepackage{caption}
---

```{r setup, include=FALSE, echo=FALSE}
  library(tidyverse)
  library(Hmisc)
  library(survey)
  options(scipen=999) # Turn off scientific notation
  options(survey.lonely.psu="adjust") 
  renv::activate(project = here::here(".."))
  source(here::here("..", "_common.R"))
  
```

```{r dataio, echo=FALSE}

# read in practice data
dat.mock <- read.csv(here("verification","verification_input","practice_data.csv"), stringsAsFactors = F)

# indicator for immunogenicity reporting
dat <- subset(dat.mock, Perprotocol == 1 & EventTimePrimaryD57 >= 7)
dat$immuno_ind <- with(dat, ifelse(Perprotocol==1 & SubcohortInd==1 & TwophasesampIndD57==1 & !is.na(wt.subcohort), 1, 0))

# LLoQ truncation for readout (bindN, live)
dat$BbindN[dat$BbindN<log10(20)] <- log10(10)
dat$Day29bindN[dat$Day29bindN<log10(20)] <- log10(10)
dat$Day57bindN[dat$Day57bindN<log10(20)] <- log10(10)
dat$Bliveneutmn50[dat$Bliveneutmn50<log10(62.16)] <- log10(31)
dat$Day29liveneutmn50[dat$Day29liveneutmn50<log10(62.16)] <- log10(31)
dat$Day57liveneutmn50[dat$Day57liveneutmn50<log10(62.16)] <- log10(31)

# ULoQ truncation for readout (bindSpike, bindRBD, bindN, live)
dat$BbindSpike[dat$BbindSpike>log10(19136250)] <- log10(19136250)
dat$BbindRBD[dat$BbindRBD>log10(19136250)] <- log10(19136250)
dat$BbindN[dat$BbindN>log10(19136250)] <- log10(19136250)
dat$Bliveneutmn50[dat$Bliveneutmn50>log10(18976.19)] <- log10(18976.19)

dat$Day29bindSpike[dat$Day29bindSpike>log10(19136250)] <- log10(19136250)
dat$Day29bindRBD[dat$Day29bindRBD>log10(19136250)] <- log10(19136250)
dat$Day29bindN[dat$Day29bindN>log10(19136250)] <- log10(19136250)
dat$Day29liveneutmn50[dat$Day29liveneutmn50>log10(18976.19)] <- log10(18976.19)

dat$Day57bindSpike[dat$Day57bindSpike>log10(19136250)] <- log10(19136250)
dat$Day57bindRBD[dat$Day57bindRBD>log10(19136250)] <- log10(19136250)
dat$Day57bindN[dat$Day57bindN>log10(19136250)] <- log10(19136250)
dat$Day57liveneutmn50[dat$Day57liveneutmn50>log10(18976.19)] <- log10(18976.19)

# reset all delta values
dat$Delta57overBbindSpike = dat$Day57bindSpike - dat$BbindSpike
dat$Delta57overBbindRBD = dat$Day57bindRBD - dat$BbindRBD
dat$Delta57overBbindN = dat$Day57bindN - dat$BbindN
dat$Delta57overBpseudoneutid50 = dat$Day57pseudoneutid50 - dat$Bpseudoneutid50
dat$Delta57overBpseudoneutid80 = dat$Day57pseudoneutid80 - dat$Bpseudoneutid80
dat$Delta57overBliveneutmn50 = dat$Day57liveneutmn50 - dat$Bliveneutmn50

dat$Delta29overBbindSpike = dat$Day29bindSpike - dat$BbindSpike
dat$Delta29overBbindRBD = dat$Day29bindRBD - dat$BbindRBD
dat$Delta29overBbindN = dat$Day29bindN - dat$BbindN
dat$Delta29overBpseudoneutid50 = dat$Day29pseudoneutid50 - dat$Bpseudoneutid50
dat$Delta29overBpseudoneutid80 = dat$Day29pseudoneutid80 - dat$Bpseudoneutid80
dat$Delta29overBliveneutmn50 = dat$Day29liveneutmn50 - dat$Bliveneutmn50

dat$Delta57over29bindSpike = dat$Day57bindSpike - dat$Day29bindSpike
dat$Delta57over29bindRBD = dat$Day57bindRBD - dat$Day29bindRBD
dat$Delta57over29bindN = dat$Day57bindN - dat$Day29bindN
dat$Delta57over29pseudoneutid50 = dat$Day57pseudoneutid50 - dat$Day29pseudoneutid50
dat$Delta57over29pseudoneutid80 = dat$Day57pseudoneutid80 - dat$Day29pseudoneutid80
dat$Delta57over29liveneutmn50 = dat$Day57liveneutmn50 - dat$Day29liveneutmn50

# wide to long by marker and timepoint
dat.long <- dat %>%
  pivot_longer(colnames(dat)[grepl("bindN|bindRBD|bindSpike|pseudoneut|liveneutmn", colnames(dat))], names_to = "time_marker", values_to = "readout_trunc") %>% filter(!grepl("CPV", time_marker)) %>%
  mutate(time = gsub("bindN|bindRBD|bindSpike|pseudoneutid.*|liveneutmn.*", "", time_marker),
         marker = gsub("^B|^Day29|^Day57|^29|^57", "", gsub("Delta29over|Delta57over", "", time_marker)))


# define subgroups: age, risk, age & risk, sex, EthnicityHispanic, race, minority, age & minority etc
dat.long <- dat.long %>%
  mutate(Age65C = ifelse(age.geq.65 == 1, "Age >= 65", "Age < 65"),
         HighRiskC = ifelse(HighRiskInd == 1, "At-risk", "Not at-risk"),
         SexC = ifelse(Sex == 1, "Female", "Male"),
         EthHisC = ifelse(EthnicityHispanic==1, "Hispanic or Latino",
                                  ifelse(EthnicityHispanic==0 & EthnicityNotreported==0 & EthnicityUnknown==0, "Not Hispanic or Latino",
                                         ifelse(EthnicityNotreported==1 | EthnicityUnknown==1, "Not reported and unknown ", NA))),
         RaceEthC = as.character(race),
         MinorityC = ifelse(WhiteNonHispanic == 0, "Communities of Color",
                            ifelse(WhiteNonHispanic == 1, "White Non-Hispanic", NA)),
         AgeRiskC = paste(Age65C, HighRiskC),
         AgeSexC = paste(Age65C, SexC),
         AgeMinorC = ifelse(!is.na(MinorityC), paste(Age65C, MinorityC), NA)
  )

# create a new RaceEthC including white hispanic for demographic table reporting
dat.long$RaceEthC2=dat.long$RaceEthC
dat.long$RaceEthC2[which(dat.long$RaceEthC2 == 'White' & dat.long$WhiteNonHispanic == 1)] <- 'White Non-Hispanic '
# code white non-hispanic group and set white hispanic as NA
dat.long$RaceEthC[which(dat.long$RaceEthC == 'White' & dat.long$WhiteNonHispanic == 1)] <- 'White Non-Hispanic '
dat.long$RaceEthC[which(dat.long$RaceEthC == 'White')] <- NA

# define LLoD, response variables
dat.long <- dat.long %>% 
  mutate(LLoD = ifelse(grepl("bind", marker), 20, 
                       ifelse(grepl("pseudo", marker), 10, 
                              ifelse(grepl("live", marker), 62.16, NA))),

         bind_response_2LD = ifelse(grepl("bind", marker) & readout_trunc>=log10(2*LLoD) & !grepl("Delta",time), 1, ifelse(grepl("bind", marker) & readout_trunc<log10(2*LLoD) & !grepl("Delta",time), 0, NA)),
         bind_response_4LD = ifelse(grepl("bind", marker) & readout_trunc>=log10(4*LLoD) & !grepl("Delta",time), 1, ifelse(grepl("bind", marker) & readout_trunc<log10(4*LLoD) & !grepl("Delta",time), 0, NA)),
         
         baseline_lt_thres = ifelse(time=="B" & readout_trunc >= log10(LLoD), 1, 0),
         increase_4F_D29 = ifelse(time=="Delta29overB" & readout_trunc>log10(4), 1, 0),
         increase_4F_D57 = ifelse(time=="Delta57overB" & readout_trunc>log10(4), 1, 0),
         
         response_2FR = ifelse(grepl("Delta",time) & readout_trunc>=log10(2), 1, 
                               ifelse(grepl("Delta",time) & readout_trunc<log10(2), 0, NA)),
         response_4FR = ifelse(grepl("Delta",time) & readout_trunc>=log10(4), 1, 
                               ifelse(grepl("Delta",time) & readout_trunc<log10(4), 0, NA))
         ) %>%
  group_by(Ptid, marker) %>%
  mutate(baseline_lt_thres_ptid=max(baseline_lt_thres),
         increase_4F_D29_ptid=max(increase_4F_D29),
         increase_4F_D57_ptid=max(increase_4F_D57)) %>%
  ungroup() %>%
  mutate(response = ifelse(time %in% c("B","Day29","Day57") & baseline_lt_thres_ptid == 0 & readout_trunc > log10(LLoD), 1,
                           ifelse(baseline_lt_thres_ptid == 1 & time == "B", 1, 
                                  ifelse(baseline_lt_thres_ptid == 1 & time == "Day29" & increase_4F_D29_ptid==1, 1, 
                                         ifelse(baseline_lt_thres_ptid == 1 & time == "Day57" & increase_4F_D57_ptid==1, 1,
                                                ifelse(time %in% c("B","Day29","Day57"), 0, NA))))))


# label Trt, Bserostatus, time and marker
dat.long <- dat.long %>% 
  mutate(Trt_lb = ifelse(Trt == 0, "Placebo", "Vaccine"),
         Baseline = ifelse(Bserostatus == 0, "Negative","Positive"),
         Visit = ifelse(time == "B", "Day 1", 
                        ifelse(time=="Day29", "Day 29", 
                               ifelse(time=="Day57","Day 57", 
                                      ifelse(time=="Delta29overB","D29 fold-rise over D1",
                                             ifelse(time=="Delta57over29","D57 fold-rise over D29",
                                                    ifelse(time=="Delta57overB","D57 fold-rise over D1", NA)))))),
         Marker = ifelse(marker=="bindSpike","Anti Spike IgG (IU/ml)",
                           ifelse(marker=="bindRBD","Anti RBD IgG (IU/ml)", 
                                  ifelse(marker=="bindN","Anti N IgG (IU/ml)",
                                         ifelse(marker=="pseudoneutid50","Pseudovirus-nAb ID50",
                                                ifelse(marker=="pseudoneutid80","Pseudovirus-nAb ID80",
                                                       ifelse(marker=="liveneutmn50","Live virus-nAb MN50", NA)))))))

# define cases, controls
dat.long <- dat.long %>% 
  mutate(case_flag = ifelse(Perprotocol == 1 & EventIndPrimaryD57 == 0, "Non_cases_Control",
                            ifelse(Perprotocol==1 & EventIndPrimaryD57==1, "Cases", NA)
))

# stack dat.long for looping by subgroups in some tables
dat.long.stack <- dat.long %>% mutate(Group="All participants",VarName="All participants") %>% 
  bind_rows(dat.long %>% mutate(Group=Age65C,VarName="Age")) %>% 
  bind_rows(dat.long %>% mutate(Group=HighRiskC,VarName="Risk for Severe Covid-19")) %>%
  bind_rows(dat.long %>% mutate(Group=AgeRiskC,VarName="Age, Risk for Severe Covid-19")) %>%
  bind_rows(dat.long %>% mutate(Group=SexC,VarName="Sex")) %>%
  bind_rows(dat.long %>% mutate(Group=EthHisC,VarName="Hispanic or Latino ethnicity")) %>%
  bind_rows(dat.long %>% mutate(Group=RaceEthC,VarName="Race")) %>% 
  bind_rows(dat.long %>% mutate(Group=MinorityC,VarName="Underrepresented minority status")) %>% 
  bind_rows(dat.long %>% mutate(Group=AgeMinorC,VarName="Age, Underrepresented minority status")) %>% 
  bind_rows(dat.long %>% mutate(Group=AgeSexC,VarName="Age, sex")) %>%
  bind_rows(dat.long %>% mutate(Group=case_flag,VarName="Cases/non-cases")) %>%
  bind_rows(dat.long %>% mutate(Group=Trt_lb,VarName="Arm")) %>%
  bind_rows(dat.long %>% mutate(Group=Baseline,VarName="Baseline SARS-CoV-2"))

VarName_levels <- c("All participants","Age","Risk for Severe Covid-19","Age, Risk for Severe Covid-19","Sex","Age, sex", "Hispanic or Latino ethnicity","Race","Underrepresented minority status","Age, Underrepresented minority status")

# parameters set-up
tbl_num <- 1
groupby_vars=c("VarName","Group","Baseline", "Trt_lb", "Marker", "Visit")
two_timepoints=c("Day 29","Day 57")
three_timepoints=c("Day 1","Day 29","Day 57")
  
## functions
decimal_f <- function(x, d) { # rounding values
  trimws(format(round(x, d), nsmall=d))
}

load(here("verification","verification_input","Tables_verificatiton_immuno.Rdata"))

```

\captionsetup[table]{labelformat=empty}

\clearpage

## Table 1. Demographic  

```{r table1, results = "asis", echo=FALSE, message=FALSE}
fig_footer <- c("This table summarises the case-cohort, which measures antibody markers at (Day 1, Day 29, and Day 57)")
 
for (i in c("Negative", "Positive")){
  
  demo <- subset(dat.long, Baseline==i) %>% filter(immuno_ind==1) %>%
    select(Trt_lb, Ptid, Age65C, HighRiskC, SexC, EthHisC, RaceEthC2, MinorityC, AgeRiskC) %>% 
    mutate(MinorityC = ifelse(is.na(MinorityC), "NA", MinorityC)) %>%
    unique() %>% 
    mutate(AgeRiskC=ifelse(grepl("Age >= 65", AgeRiskC), "Age >= 65 ", AgeRiskC))
  
  
  demo.long <- demo %>%
    pivot_longer(!c(Trt_lb, Ptid), names_to = "VarName", values_to="Group")
  
  rr_table1_by_trt <- demo.long %>% 
    group_by(Trt_lb, VarName, Group) %>% 
    filter(!is.na(Group)) %>%
    summarise(N=n()) %>% 
    mutate(n_freq = paste0(N, " (", decimal_f( N / sum(N) * 100, 1),"%)")) %>% 
    select(-N) %>%
    pivot_wider(names_from = "Trt_lb", values_from = "n_freq") %>% 
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% mutate(Trt_lb = ifelse(Trt==0, "Placebo", "Vaccine")) %>%
        group_by(Trt_lb) %>% 
        summarise(age=paste0(decimal_f(mean(Age),1), " (", decimal_f(min(Age),1),", ",decimal_f(max(Age),1),")")) %>%
        pivot_wider(names_from = "Trt_lb", values_from="age") %>%
        mutate(VarName="Age65C",
               Group="Mean (Range)")
    ) %>%
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% mutate(Trt_lb = ifelse(Trt==0, "Placebo", "Vaccine")) %>%
        group_by(Trt_lb) %>% 
        summarise(BMI=paste0(decimal_f(mean(BMI),1), " +/- ", decimal_f(sd(BMI),1))) %>%
        pivot_wider(names_from = "Trt_lb", values_from="BMI") %>%
        mutate(VarName="BMI",
               Group="Mean +/- SD")
    )
  
  rr_table1_tot<- demo.long %>% 
    group_by(VarName, Group) %>% 
    filter(!is.na(Group)) %>%
    summarise(N=n()) %>% 
    mutate(Total = paste0(N, " (", decimal_f( N / sum(N) * 100, 1),"%)")) %>% 
    select(-N) %>%
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% 
        summarise(Total=paste0(decimal_f(mean(Age),1), " (", decimal_f(min(Age),1),", ",decimal_f(max(Age),1),")")) %>%
        mutate(VarName="Age65C",
               Group="Mean (Range)")
    ) %>%
    bind_rows(
      subset(dat, Bserostatus==ifelse(i=="Negative",0, 1) & immuno_ind==1) %>% 
        summarise(Total=paste0(decimal_f(mean(BMI),1), " +/- ", decimal_f(sd(BMI),1))) %>%
        mutate(VarName="BMI",
               Group="Mean +/- SD")
    )
  
  
  rr_table1 <- rr_table1_by_trt %>%
    left_join(rr_table1_tot,  by=c("VarName","Group")) %>%
    filter(!is.na(Group)) %>%
    mutate(VarName=gsub("AgeRisk","Age, Risk for Severe Covid-19", gsub("HighRisk","Risk for Severe Covid-19", gsub("His","Hispanic or Latino ethnicity", gsub("EthC2|Eth|65|C", "", VarName))))) %>%
    mutate(VarName=ifelse(VarName=="Minority", "Race", VarName)) %>%
    select(VarName, Group, Placebo, Vaccine, Total)
  
  
  count <- demo %>% group_by(Trt_lb) %>%  summarise(N=n())
  
  colnames(rr_table1) = c("subgroup", "Characteristics", paste0(count$Trt_lb,"\n(N = ",count$N,")"), paste0("Total\n(N = ", sum(count$N),")"))
  
  rr_table1 <- rr_table1 %>% select(1,2,4,3,5)

  if (i=="Negative"){
    # comparison
    tab_dm_neg[] <- lapply(tab_dm_neg, as.character)
    rr_table1.1 = tab_dm_neg[, c("subgroup","Characteristics")] %>% left_join(rr_table1, by=c("subgroup","Characteristics"))
    testthat::expect_equal(rr_table1.1, tab_dm_neg)
    
  } else if (i=="Positive"){
    # comparison
    tab_dm_pos[] <- lapply(tab_dm_pos, as.character)
    rr_table1.2 = tab_dm_pos[, c("subgroup","Characteristics")] %>% left_join(rr_table1, by=c("subgroup","Characteristics"))
    testthat::expect_equal(rr_table1.2, tab_dm_pos)
  }

}

save(rr_table1.1, rr_table1.2,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_tables1.Rdata"))

```

\clearpage

## Table 2. Percentage of responders, and participants with concentrations >= 2 x LLOD or >= 4 x LLOD for binding antibody markers by All participants

```{r table2, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}
fig_footer <- c("Binding Antibody Responders are defined as participants who had baseline values below the LLOD with detectable antibody concentration above the assay LLOD, or as participants with baseline values above the LLOD with a 4-fold increase in antibody concentration.")

ind=1
rr_table2_list=list()
for (v in VarName_levels){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)")){
    for (tp in two_timepoints){
      
      letter=letters[ind]
      
       rr2 <- subset(dat.long.stack, VarName==v) %>% filter(Visit == tp & Marker == mk)
       
       design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr2)
       
       mod1 <- svyby(~response,  by=~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
       colnames(mod1) <- c(colnames(mod1)[1:7], "mod1 2.5 %", "mod1 97.5 %")
       
       mod2 <- svyby(~bind_response_2LD, by=~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
       colnames(mod2) <- c(colnames(mod2)[1:7], "mod2 2.5 %", "mod2 97.5 %")
       
       mod3 <- svyby(~bind_response_4LD, by=~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
       colnames(mod3) <- c(colnames(mod3)[1:7], "mod3 2.5 %", "mod3 97.5 %")
       
       res <-  rr2 %>% filter(immuno_ind==1 & !is.na(Group)) %>%
        group_by_at(groupby_vars) %>%
        summarise(N=n(),
                  `Responder_1`=paste0(round(sum(response * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                  `% Greater than 2xLLOD_1`=paste0(round(sum(bind_response_2LD * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                  `% Greater than 4xLLOD_1`=paste0(round(sum(bind_response_4LD * wt.subcohort),1),"/",round(sum(wt.subcohort),1))) %>%
         left_join(mod1, by=groupby_vars) %>%
         left_join(mod2, by=groupby_vars) %>%
         left_join(mod3, by=groupby_vars) %>%
         mutate(`Responder_2` = ifelse(!is.nan(`mod1 97.5 %`), paste0(decimal_f(response*100,1),"%\n(", decimal_f(`mod1 2.5 %`*100,1),"%, ", decimal_f(`mod1 97.5 %`*100,1),"%)"), paste0(decimal_f(response*100,1),"%")),
                `% Greater than 2xLLOD_2` = ifelse(!is.nan(`mod2 97.5 %`), paste0(decimal_f(bind_response_2LD*100,1),"%\n(", decimal_f(`mod2 2.5 %`*100,1),"%, ", decimal_f(`mod2 97.5 %`*100,1),"%)"), paste0(decimal_f(bind_response_2LD*100,1),"%")),
                `% Greater than 4xLLOD_2` = ifelse(!is.nan(`mod3 97.5 %`), paste0(decimal_f(bind_response_4LD*100,1),"%\n(", decimal_f(`mod3 2.5 %`*100,1),"%, ", decimal_f(`mod3 97.5 %`*100,1),"%)"), paste0(decimal_f(bind_response_4LD*100,1),"%"))
                ) %>%
         mutate(`Responder` = paste0(`Responder_1`, " = ", `Responder_2`),
                `% Greater than 2xLLOD` = paste0(`% Greater than 2xLLOD_1`, " = ", `% Greater than 2xLLOD_2`),
                `% Greater than 4xLLOD` = paste0(`% Greater than 4xLLOD_1`, " = ", `% Greater than 4xLLOD_2`)) %>%
         select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, `Responder`:`% Greater than 4xLLOD`)
      
      rr_table2 <- res
      colnames(rr_table2) <- c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker","N","Responder", "% Greater than 2xLLOD", "% Greater than 4xLLOD")
      
      # comparison
      rr_table2$Group=ifelse(rr_table2$subgroup=="All participants", "", rr_table2$Group)
     
      rr_table2_list[[ind]] <- rr_table2
      
      ind=ind+1
    }
  }
}

rr_table2_all <- do.call("rbind", rr_table2_list)
dim(rr_table2_all)==dim(tab_bind)

tab_bind[] <- lapply(tab_bind, as.character)
rr_table2_all[] <- lapply(rr_table2_all, as.character)

rr_table2_all = tab_bind[,c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>% left_join(rr_table2_all, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(rr_table2_all, tab_bind)

save(rr_table2_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table2.Rdata"))
```

\clearpage

## Table 3. Percentage of responders, and participants participants with 2-fold rise, and participants with 4-fold rise for ID50 pseudo-virus neutralization antibody markers

```{r table3, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}
fig_footer <- c("Neutralization Responders are defined as participants who had baseline values below the lower limit of detection (LLOD) with detectable ID50 neutralization titer above the assay LLOD, or as participants with baseline values above the LLOD with a 4-fold increase in ID50.")

ind=1
rr_table3_list=list()
for (v in VarName_levels){
  for (mk in c("Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
    for (tp in two_timepoints){
  
    letter=letters[ind]
    
    rr3 <- subset(dat.long.stack, VarName==v) %>%
      filter(Marker == mk & Visit == tp) %>%
      select(Ptid, VarName, Group, Visit, Trt_lb, Baseline, Marker, wt.subcohort, tps.stratum, response, immuno_ind) %>%
      left_join(
        subset(dat.long.stack, VarName==v) %>%
        filter(Marker == mk & grepl("D29 fold-rise over D1|D57 fold-rise over D1", Visit)) %>%
        mutate(Visit=ifelse(Visit=="D29 fold-rise over D1","Day 29",
                            ifelse(Visit=="D57 fold-rise over D1","Day 57", NA))) %>%
        select(Ptid, VarName, Group, Visit, Trt_lb, Baseline, Marker, wt.subcohort, tps.stratum,        response_2FR, response_4FR),
        by=c("Ptid",groupby_vars, "wt.subcohort", "tps.stratum")
      )
    
     design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr3)
  
     mod1 <- svyby(~response, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod1) <- c(colnames(mod1)[1:7], "mod1 2.5 %", "mod1 97.5 %")
     
     mod2 <- svyby(~response_2FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod2) <- c(colnames(mod2)[1:7], "mod2 2.5 %", "mod2 97.5 %")
     
     mod3 <- svyby(~response_4FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop,ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod3) <- c(colnames(mod3)[1:7], "mod3 2.5 %", "mod3 97.5 %")
     
     res <-  rr3 %>%  filter(immuno_ind==1 & !is.na(Group)) %>%
      group_by_at(groupby_vars) %>%
      summarise(N=n(),
                `Responder_1`=paste0(round(sum(response * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                `% 2-Fold Rise_1`=paste0(round(sum(response_2FR * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                `% 4-Fold Rise_1`=paste0(round(sum(response_4FR * wt.subcohort),1),"/",round(sum(wt.subcohort),1))) %>%
       left_join(mod1, by=groupby_vars) %>%
       left_join(mod2, by=groupby_vars) %>%
       left_join(mod3, by=groupby_vars) %>%
       mutate(`Responder_2` = ifelse(!is.nan(`mod1 97.5 %`), paste0(decimal_f(response*100,1),"%\n(", decimal_f(`mod1 2.5 %`*100,1),"%, ", decimal_f(`mod1 97.5 %`*100,1),"%)"),paste0(decimal_f(response*100,1),"%")),
              `% 2-Fold Rise_2` = ifelse(!is.nan(`mod2 97.5 %`), paste0(decimal_f(response_2FR*100,1),"%\n(", decimal_f(`mod2 2.5 %`*100,1),"%, ", decimal_f(`mod2 97.5 %`*100,1),"%)"),paste0(decimal_f(response_2FR*100,1),"%")),
              `% 4-Fold Rise_2` = ifelse(!is.nan(`mod3 97.5 %`), paste0(decimal_f(response_4FR*100,1),"%\n(", decimal_f(`mod3 2.5 %`*100,1),"%, ", decimal_f(`mod3 97.5 %`*100,1),"%)"),paste0(decimal_f(response_4FR*100,1),"%"))
              ) %>%
       mutate(`Responder` = paste0(`Responder_1`, " = ", `Responder_2`),
              `% 2-Fold Rise` = paste0(`% 2-Fold Rise_1`, " = ", `% 2-Fold Rise_2`),
              `% 4-Fold Rise` = paste0(`% 4-Fold Rise_1`, " = ", `% 4-Fold Rise_2`)) %>%
       select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, `Responder`:`% 4-Fold Rise`)
    
    rr_table3 <- res
    colnames(rr_table3) <- c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker","N","Responder", "% 2-Fold Rise", "% 4-Fold Rise")
  
    rr_table3$Group=ifelse(rr_table3$subgroup=="All participants", "", rr_table3$Group)
    rr_table3_list[[ind]] <- rr_table3
    
    ind=ind+1
    }
  }
}

# comparison
rr_table3_all <- do.call("rbind", rr_table3_list)
rr_table3_all[] <- lapply(rr_table3_all, as.character)

rr_table3_all_sub <- subset(rr_table3_all,Marker=="Pseudovirus-nAb ID50")
dim(rr_table3_all_sub)==dim(tab_pseudo)

tab_pseudo[] <- lapply(tab_pseudo, as.character)
rr_table3_all_sub[] <- lapply(rr_table3_all_sub, as.character)

rr_table3_all_sub <- tab_pseudo[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>%
  left_join(rr_table3_all_sub, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(rr_table3_all_sub, tab_pseudo)

save(rr_table3_all_sub,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table3.Rdata"))
```

\clearpage

## Table 4. Percentage of responders, and participants participants with 2-fold rise, and participants with 4-fold rise for MN50 WT live virus neutralization antibody markers

```{r table4, results = "asis", echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
fig_footer <- c("Neutralization Responders are defined as participants who had baseline values below the lower limit of detection (LLOD) with detectable ID50 neutralization titer above the assay LLOD, or as participants with baseline values above the LLOD with a 4-fold increase in ID50.")

ind=1
rr_table4_list=list()
for (v in VarName_levels){
  for (mk in c("Live virus-nAb MN50")){
    for (tp in two_timepoints){
  
    letter=letters[ind]
    
    rr4 <- subset(dat.long.stack, VarName==v) %>%
      filter(Marker== mk & Visit == tp) %>%
      select(Ptid, VarName, Group, Visit, Trt_lb, Baseline, Marker, wt.subcohort, tps.stratum, response, immuno_ind) %>%
      left_join(
        subset(dat.long.stack, VarName==v) %>%
        filter(Marker== mk & grepl("D29 fold-rise over D1|D57 fold-rise over D1", Visit)) %>%
        mutate(Visit=ifelse(Visit=="D29 fold-rise over D1","Day 29",
                            ifelse(Visit=="D57 fold-rise over D1","Day 57", NA))) %>%
        select(Ptid, VarName, Group, Visit, Trt_lb, Baseline, Marker, wt.subcohort, tps.stratum,        response_2FR, response_4FR),
        by=c("Ptid",groupby_vars, "wt.subcohort", "tps.stratum")
      )
    
     design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr4)
  
     mod1 <- svyby(~response, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod1) <- c(colnames(mod1)[1:7], "mod1 2.5 %", "mod1 97.5 %")
     
     mod2 <- svyby(~response_2FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod2) <- c(colnames(mod2)[1:7], "mod2 2.5 %", "mod2 97.5 %")
     
     mod3 <- svyby(~response_4FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
     colnames(mod3) <- c(colnames(mod3)[1:7], "mod3 2.5 %", "mod3 97.5 %")
     
     res4 <-  rr4 %>% filter(immuno_ind==1 & !is.na(Group)) %>%
      group_by_at(groupby_vars) %>%
      summarise(N=n(),
                `Responder_1`=paste0(round(sum(response * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                `% 2-Fold Rise_1`=paste0(round(sum(response_2FR * wt.subcohort),1),"/",round(sum(wt.subcohort),1)),
                `% 4-Fold Rise_1`=paste0(round(sum(response_4FR * wt.subcohort),1),"/",round(sum(wt.subcohort),1))) %>%
       left_join(mod1, by=groupby_vars) %>%
       left_join(mod2, by=groupby_vars) %>%
       left_join(mod3, by=groupby_vars) %>%
       mutate(`Responder_2` = ifelse(!is.nan(`mod1 97.5 %`), paste0(decimal_f(response*100,1),"%\n(", decimal_f(`mod1 2.5 %`*100,1),"%, ", decimal_f(`mod1 97.5 %`*100,1),"%)"),paste0(decimal_f(response*100,1),"%")),
              `% 2-Fold Rise_2` = ifelse(!is.nan(`mod2 97.5 %`), paste0(decimal_f(response_2FR*100,1),"%\n(", decimal_f(`mod2 2.5 %`*100,1),"%, ", decimal_f(`mod2 97.5 %`*100,1),"%)"),paste0(decimal_f(response_2FR*100,1),"%")),
              `% 4-Fold Rise_2` = ifelse(!is.nan(`mod3 97.5 %`), paste0(decimal_f(response_4FR*100,1),"%\n(", decimal_f(`mod3 2.5 %`*100,1),"%, ", decimal_f(`mod3 97.5 %`*100,1),"%)"),paste0(decimal_f(response_4FR*100,1),"%"))
              ) %>%
       mutate(`Responder` = paste0(`Responder_1`, " = ", `Responder_2`),
              `% 2-Fold Rise` = paste0(`% 2-Fold Rise_1`, " = ", `% 2-Fold Rise_2`),
              `% 4-Fold Rise` = paste0(`% 4-Fold Rise_1`, " = ", `% 4-Fold Rise_2`)) %>%
       select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, `Responder`:`% 4-Fold Rise`)
    
    rr_table4 <- res4
    colnames(rr_table4) <- c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker","N","Responder", "% 2-Fold Rise", "% 4-Fold Rise")
    
    rr_table4$Group=ifelse(rr_table4$subgroup=="All participants", "", rr_table4$Group)
  
    rr_table4_list[[ind]] <- rr_table4
    
    ind=ind+1
    }
  }
}

# comparison
rr_table4_all <- do.call("rbind", rr_table4_list)
dim(rr_table4_all)==dim(tab_wt)

tab_wt[] <- lapply(tab_wt, as.character)
rr_table4_all[] <- lapply(rr_table4_all, as.character)
rr_table4_all <- tab_wt[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>%
  left_join(rr_table4_all, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(rr_table4_all, tab_wt)

save(rr_table4_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table4.Rdata"))
```

\clearpage

## Table 5. Geometric mean titers (GMTs) and geometric mean concentrations (GMCs)    

```{r table5, results = "asis", echo=FALSE, message=FALSE}
fig_footer <- c("")

ind=1
rr_table5_list=list()
for (v in VarName_levels){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
    for (tp in three_timepoints){
  
    letter=letters[ind]
    
    rr5 <- subset(dat.long.stack, VarName==v) %>%
      filter(Marker==mk & Visit == tp)
    
    design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr5)
    
    mod = svyby(~readout_trunc, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design, svymean, ci=TRUE, vartype="ci", na.rm=T)
    
    res5 <- rr5 %>% filter(immuno_ind==1 & !is.na(Group)) %>%
      group_by_at(groupby_vars) %>%
      summarise(N=n()) %>%
      left_join(mod, by=groupby_vars) %>%
      mutate(GMT = paste0(decimal_f(10^readout_trunc, 0),"\n(", decimal_f(10^ci_l, 0),", ", decimal_f(10^ci_u,0),")")) %>%
      select(VarName, Group, Visit, Trt_lb, Baseline, Marker, N, GMT)
      
    rr_table5 <- res5
    colnames(rr_table5) <- c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker","N","GMT/GMC")
  
    rr_table5$Group=ifelse(rr_table5$subgroup=="All participants", "", rr_table5$Group)
    
    rr_table5_list[[ind]] <- rr_table5
  
    ind=ind+1
    }
  }
}

# comparison
rr_table5_all <- do.call("rbind", rr_table5_list)  
dim(rr_table5_all)==dim(tab_gm)

tab_gm[] <- lapply(tab_gm, as.character)
rr_table5_all[] <- lapply(rr_table5_all, as.character)

rr_table5_all <- tab_gm[, c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker")] %>% left_join(rr_table5_all, by=c("subgroup","Group","Visit","Arm","Baseline SARS-CoV-2","Marker"))

testthat::expect_equal(rr_table5_all, tab_gm)

save(rr_table5_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table5.Rdata"))
```

\clearpage

## Table 6. Geometric mean titer ratios (GMTRs) or geometric mean concentration ratios (GMCRs) between post-vaccinations/pre-vaccination

```{r table6, results = "asis", echo=FALSE, warning=FALSE, message=F}
fig_footer <- c("")

ind=1
rr_table6_list=list()
for (v in VarName_levels){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
    for (tp in c("D29 fold-rise over D1","D57 fold-rise over D1")){
  
    letter=letters[ind]
    
    rr6 <- subset(dat.long.stack, VarName==v) %>%
      filter(Marker == mk & Visit == tp)
      
    design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr6)
    
    mod <- svyby(~readout_trunc, ~VarName+Group+Visit+Baseline+Trt_lb+Marker, design, svymean, ci=TRUE, vartype="ci", na.rm=T)
    
    res6 <-  mod %>%
        mutate(`GMTR/GMCR`= paste0(decimal_f(10^readout_trunc,2), "\n(", decimal_f(10^ci_l,2), ", ", decimal_f(10^ci_u,2),")")) %>%
        select(VarName, Group, Baseline, Trt_lb, Marker, `GMTR/GMCR`, Visit)
      
    rr_table6<- res6
    colnames(rr_table6) <- c("subgroup", "Group", "Baseline SARS-CoV-2", "Arm", "Marker", "GMTR/GMCR","Visit")
    
    rr_table6$Group=ifelse(rr_table6$subgroup=="All participants", "", rr_table6$Group)
    
    rr_table6_list[[ind]] <- rr_table6
  
    ind=ind+1
    }
  }
}

# comparison
rr_table6_all <- do.call("rbind", rr_table6_list)
rr_table6_all <- merge(rr_table6_all, (rr_table5_all %>% pivot_wider(names_from=Visit, values_from=`GMT/GMC`)), by=c("subgroup","Group","Arm","Baseline SARS-CoV-2","Marker"))
rr_table6_all$`Baseline\nGMT/GMC`=rr_table6_all$`Day 1`
rr_table6_all$`Post Baseline\nGMT/GMC`=with(rr_table6_all, ifelse(rr_table6_all$Visit=="D29 fold-rise over D1", `Day 29`, `Day 57`))
rr_table6_all <- rr_table6_all %>% 
  select(1:2, 7, 3:5, 8, 12, 13, 6)


tab_gmr[] <- lapply(tab_gmr, as.character)
rr_table6_all[] <- lapply(rr_table6_all, as.character)

rr_table6_all <- tab_gmr[, c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker")] %>% left_join(rr_table6_all, by=c("subgroup","Group","Visit","Arm", "Baseline SARS-CoV-2","Marker"))

dim(rr_table6_all)==dim(tab_gmr)

testthat::expect_equal(rr_table6_all, tab_gmr)

save(rr_table6_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table6.Rdata"))
```

\clearpage

## Table 7. The ratios of GMTs/GMCs between groups

```{r table7, results = "asis", echo=FALSE, message=FALSE}
fig_footer <- c("")

ind=1
ind_for_age_risk=1
rr_table7_list=list()
VarName_levels_Comp=c("Age","Age, Risk for Severe Covid-19","Age, Risk for Severe Covid-19","Sex","Hispanic or Latino ethnicity","Underrepresented minority status","Risk for Severe Covid-19")
for (v in VarName_levels_Comp){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
    for (tp in three_timepoints){
  
    letter=letters[ind]
    
    rr7 <- subset(dat.long.stack, VarName == v) %>% 
      filter(Marker == mk & Visit == tp)
    
     if(v=="Hispanic or Latino ethnicity") {
       
       design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr7), Group %in% c("Hispanic or Latino", "Not Hispanic or Latino"))
                            
     } else if (v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==2){
      
      design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr7), Group %in% c("Age < 65 At-risk","Age < 65 Not at-risk"))
      
    } else if (v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==3) {
      
      design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr7), Group %in% c("Age >= 65 At-risk","Age >= 65 Not at-risk"))

    } else {
      
      design <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr7)
      
    }
    
    mod <- svyby(readout_trunc ~ Group, ~VarName+Visit+Trt_lb+Baseline+Marker, design, svyglm, vartype="ci")
    
    res7 <- mod %>% 
      rowwise() %>%
      mutate(Ratio=ifelse(v=="Age", paste0(decimal_f(10^`GroupAge >= 65`,2),"\n(",decimal_f(10^`ci_l.GroupAge >= 65`,2),", ",decimal_f(10^`ci_u.GroupAge >= 65`,2),")"),
                          ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==2,    paste0(decimal_f(10^-`GroupAge < 65 Not at-risk`,2),"\n(",decimal_f(10^-`ci_u.GroupAge < 65 Not at-risk`,2),", ",decimal_f(10^-`ci_l.GroupAge < 65 Not at-risk`,2),")"),
                                  ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==3, paste0(decimal_f(10^-`GroupAge >= 65 Not at-risk`,2),"\n(",decimal_f(10^-`ci_u.GroupAge >= 65 Not at-risk`,2),", ",decimal_f(10^-`ci_l.GroupAge >= 65 Not at-risk`,2),")"),
                                          ifelse(v=="Sex", paste0(decimal_f(10^`GroupMale`,2),"\n(",decimal_f(10^ci_l.GroupMale,2),", ",decimal_f(10^ci_u.GroupMale,2),")"),
                                                ifelse(v=="Hispanic or Latino ethnicity", paste0(decimal_f(10^-`GroupNot Hispanic or Latino`,2),"\n(",decimal_f(10^-`ci_u.GroupNot Hispanic or Latino`,2),", ",decimal_f(10^-`ci_l.GroupNot Hispanic or Latino`,2),")"),
                                                        ifelse(v=="Underrepresented minority status", paste0(decimal_f(10^-`GroupWhite Non-Hispanic`,2),"\n(",decimal_f(10^-`ci_u.GroupWhite Non-Hispanic`,2),", ",decimal_f(10^-`ci_l.GroupWhite Non-Hispanic`,2),")"), 
                                                               ifelse(v=="Risk for Severe Covid-19", paste0(decimal_f(10^-`GroupNot at-risk`,2),"\n(",decimal_f(10^-`ci_u.GroupNot at-risk`,2),", ",decimal_f(10^-`ci_l.GroupNot at-risk`,2),")"),NA)))))))) %>%
      mutate(`Group 1 vs 2`=ifelse(v=="Age", "Age >= 65 vs Age < 65",
                          ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==2, "Age < 65 At-risk vs Age < 65 Not at-risk",
                                 ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==3, "Age >= 65 At-risk vs Age >= 65 Not at-risk",
                                        ifelse(v=="Sex", "Male vs Female",
                                               ifelse(v=="Hispanic or Latino ethnicity", "Hispanic or Latino vs Not Hispanic or Latino",
                                                      ifelse(v=="Underrepresented minority status", "Communities of Color vs White Non-Hispanic",
                                                             ifelse(v=="Risk for Severe Covid-19", "At-risk vs Not at-risk", NA)))))))) %>%
      select(VarName, Visit, Trt_lb, Baseline, Marker, `Group 1 vs 2`, Ratio)
  
    rr_table7 <- res7
    colnames(rr_table7) <- c("subgroup", "Visit","Arm", "Baseline SARS-CoV-2", "Marker", "Group 1 vs 2", "Ratios of GMT/GMC")
    
    rr_table7_list[[ind]] <- rr_table7
    
    ind=ind+1
    }
  }
  ind_for_age_risk=ind_for_age_risk+1
}

# comparison
rr_table7_all <- do.call("rbind", rr_table7_list)

rr_table7_all <- rr_table5_all %>% filter(subgroup %in% c("Age")) %>%
  mutate(`Group 1 vs 2`="Age >= 65 vs Age < 65") %>%
  bind_rows(
    rr_table5_all %>% filter(subgroup %in% c("Sex")) %>%
  mutate(`Group 1 vs 2`="Male vs Female")) %>%
  bind_rows(
    rr_table5_all %>% filter(subgroup %in% c("Underrepresented minority status")) %>%
  mutate(`Group 1 vs 2`="Communities of Color vs White Non-Hispanic")) %>%
  bind_rows(
    rr_table5_all %>% filter(subgroup %in% c("Risk for Severe Covid-19")) %>%
  mutate(`Group 1 vs 2`="At-risk vs Not at-risk")) %>%
  bind_rows(
    rr_table5_all %>% filter(subgroup=="Age, Risk for Severe Covid-19" & Group %in% c("Age < 65 At-risk","Age < 65 Not at-risk")) %>% mutate(`Group 1 vs 2`="Age < 65 At-risk vs Age < 65 Not at-risk")) %>%
  bind_rows(rr_table5_all %>% filter(subgroup=="Age, Risk for Severe Covid-19" & Group %in% c("Age >= 65 At-risk","Age >= 65 Not at-risk")) %>% mutate(`Group 1 vs 2`="Age >= 65 At-risk vs Age >= 65 Not at-risk")) %>%
  bind_rows(rr_table5_all %>% filter(subgroup=="Hispanic or Latino ethnicity" & Group %in% c("Hispanic or Latino", "Not Hispanic or Latino")) %>% mutate(`Group 1 vs 2`="Hispanic or Latino vs Not Hispanic or Latino")) %>%
  select(-N) %>% 
  rename_with(~ gsub('GMT/GMC', 'GMT',.x)) %>%
  mutate(Group=gsub('Age >= 65$|Age < 65 At-risk$|Age >= 65 At-risk$|Male|^Hispanic or Latino|Communities of Color|At-risk$', 'Group 1 GMT/GMC', Group)) %>%
  mutate(Group=gsub('Age < 65$|Age < 65 Not at-risk$|Age >= 65 Not at-risk$|Female|Not Hispanic or Latino|White Non-Hispanic|Not at-risk$', 'Group 2 GMT/GMC', Group)) %>%
  pivot_wider(names_from=Group, values_from=GMT) %>%
  left_join(rr_table7_all,
    by=c("Group 1 vs 2", "subgroup", "Visit", "Arm", "Baseline SARS-CoV-2", "Marker")
  ) %>%
  select(6, 1:5,8,7,9)

rr_table7_all <- rr_table7_all %>% mutate(subgroup= ifelse(`Group 1 vs 2`=="Age < 65 At-risk vs Age < 65 Not at-risk", "Age < 65, Risk for Severe Covid-19", ifelse(`Group 1 vs 2`=="Age >= 65 At-risk vs Age >= 65 Not at-risk", "Age >= 65, Risk for Severe Covid-19", subgroup)))

tab_rgmt[] <- lapply(tab_rgmt, as.character)

dim(rr_table7_all)==dim(tab_rgmt)

rr_table7_all <- tab_rgmt[, c("Group 1 vs 2", "subgroup", "Visit","Arm", "Baseline SARS-CoV-2", "Marker")] %>% left_join(rr_table7_all, c("Group 1 vs 2", "subgroup", "Visit","Arm", "Baseline SARS-CoV-2", "Marker"))

testthat::expect_equal(rr_table7_all, tab_rgmt)

save(rr_table7_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table7.Rdata"))
```

\clearpage

## Table 8. Differences in the responder rates, 2FRs, 4FRs between between the vaccine arm and the placebo arm

```{r table8, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}
fig_footer <- c("")

ind=1
ind_for_age_risk=1
rr_table8_list=list()
VarName_levels_Comp=c("Arm","Baseline SARS-CoV-2", "Age","Age, Risk for Severe Covid-19","Age, Risk for Severe Covid-19","Sex","Hispanic or Latino ethnicity","Underrepresented minority status","Risk for Severe Covid-19")
for (v in VarName_levels_Comp){
  for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
    for (tp in two_timepoints){
      
    comp1 <- ifelse(v=="Arm", "Vaccine", 
                    ifelse(v=="Baseline SARS-CoV-2", "Positive",
                           ifelse(v=="Age", "Age >= 65", 
                                  ifelse(v=="Risk for Severe Covid-19", "At-risk",
                                         ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==4, "Age < 65 At-risk",
                                                ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==5, "Age >= 65 At-risk",
                                                       ifelse(v=="Sex","Male",
                                                              ifelse(v=="Hispanic or Latino ethnicity","Hispanic or Latino",ifelse(v=="Underrepresented minority status","Communities of Color", NA)))))))))
    
    comp2 <- ifelse(v=="Arm", "Placebo", 
                    ifelse(v=="Baseline SARS-CoV-2", "Negative",
                           ifelse(v=="Age", "Age < 65", 
                                  ifelse(v=="Risk for Severe Covid-19", "Not at-risk",
                                         ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==4, "Age < 65 Not at-risk",
                                                ifelse(v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==5, "Age >= 65 Not at-risk",
                                                       ifelse(v=="Sex","Female",
                                                              ifelse(v=="Hispanic or Latino ethnicity","Not Hispanic or Latino",ifelse(v=="Underrepresented minority status","White Non-Hispanic", NA)))))))))
  
    letter=letters[ind]
    
    # for response
    rr8.1 <- subset(dat.long.stack, VarName == v) %>% 
      mutate(Visit=gsub("D57","Day 57", gsub("D29","Day 29", Visit))) %>%
      filter(Marker == mk & Visit == tp)
    
    # for response_2FR, response_4FR
    rr8.2 <- subset(dat.long.stack, VarName == v) %>% 
      mutate(Visit=gsub("D57","Day 57", gsub("D29","Day 29", Visit))) %>%
      filter(Visit == paste(tp, "fold-rise over D1")) %>%
      mutate(Visit=gsub(" fold-rise over D1","",Visit)) %>%
      filter(Marker == mk & Visit == tp)
  
    if(v=="Hispanic or Latino ethnicity") {
       
       design1 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.1), Group %in% c("Hispanic or Latino", "Not Hispanic or Latino"))
       
       design2 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.2), Group %in% c("Hispanic or Latino", "Not Hispanic or Latino"))
                            
     } else if (v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==2){
      
      design1 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.1), Group %in% c("Age < 65 At-risk","Age < 65 Not at-risk"))
      
      design2 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.2), Group %in% c("Age < 65 At-risk","Age < 65 Not at-risk"))
      
    } else if (v=="Age, Risk for Severe Covid-19" & ind_for_age_risk==3) {
      
      design1 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.1), Group %in% c("Age >= 65 At-risk","Age >= 65 Not at-risk"))
      
      design2 <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.2), Group %in% c("Age >= 65 At-risk","Age >= 65 Not at-risk"))

    } else {
      
      design1 <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.1)
      
      design2 <- twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr8.2)
      
    }
  
    mod1 <- svyby(~response, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design1, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
    colnames(mod1) <- c(colnames(mod1)[1:7], "mod1ci_l", "mod1ci_u")
    
    mod2 <- svyby(~response_2FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design2, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
    colnames(mod2) <- c(colnames(mod2)[1:7], "mod2ci_l", "mod2ci_u")
     
    mod3 <- svyby(~response_4FR, ~VarName+Group+Visit+Trt_lb+Baseline+Marker, design2, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)
    colnames(mod3) <- c(colnames(mod3)[1:7], "mod3ci_l", "mod3ci_u")
    
    res8 <- mod1 %>% 
      left_join(mod2,
                by=groupby_vars) %>%
      left_join(mod3,
                by=groupby_vars) %>%
      mutate(Trt_lb=ifelse(Group==Trt_lb, "-", Trt_lb)) %>%
      mutate(Baseline=ifelse(Group==Baseline, "-", Baseline)) %>%
      pivot_wider(names_from = Group, values_from = c(response:mod3ci_u)) %>%
      rename_with(~ gsub(comp1, "comp1", gsub(comp2, "comp2", .x, fixed = TRUE))) %>%
      rowwise() %>% 
      mutate(Responder=paste0(round((response_comp1-response_comp2)*100,1),
                               "%\n(", round((response_comp1-response_comp2-sqrt((response_comp1-mod1ci_l_comp1)^2+(mod1ci_u_comp2-response_comp2)^2))*100,1),"%, ", round((response_comp1-response_comp2+sqrt((response_comp2-mod1ci_l_comp2)^2+(mod1ci_u_comp1-response_comp1)^2))*100,1),"%)")) %>%
      mutate(Responder_2FR=paste0(round((response_2FR_comp1-response_2FR_comp2)*100,1),
                               "%\n(", round((response_2FR_comp1-response_2FR_comp2-sqrt((response_2FR_comp1-mod2ci_l_comp1)^2+(mod2ci_u_comp2-response_2FR_comp2)^2))*100,1),"%, ", round((response_2FR_comp1-response_2FR_comp2+sqrt((response_2FR_comp2-mod2ci_l_comp2)^2+(mod2ci_u_comp1-response_2FR_comp1)^2))*100,1),"%)")) %>%
      mutate(Responder_4FR=paste0(round((response_4FR_comp1-response_4FR_comp2)*100,1),
                               "%\n(", round((response_4FR_comp1-response_4FR_comp2-sqrt((response_4FR_comp1-mod3ci_l_comp1)^2+(mod3ci_u_comp2-response_4FR_comp2)^2))*100,1),"%, ", round((response_4FR_comp1-response_4FR_comp2+sqrt((response_4FR_comp2-mod3ci_l_comp2)^2+(mod3ci_u_comp1-response_4FR_comp1)^2))*100,1),"%)")) %>%
      mutate(Comparison=paste(comp1, "vs", comp2)) %>%
      select(VarName, Visit, Baseline, Trt_lb, Marker, Comparison, Responder, Responder_2FR, Responder_4FR)
  
      rr_table8 <- res8
      colnames(rr_table8) <- c("subgroup","Visit","Baseline SARS-CoV-2","Arm","Marker","Comparison", "Responder","% 2-Fold Rise","% 4-Fold Rise")
  
      rr_table8_list[[ind]] <- rr_table8    
     
     ind=ind+1
    }
  }
  ind_for_age_risk=ind_for_age_risk+1
}

# comparison
rr_table8_all <- do.call("rbind", rr_table8_list)  

rr_table8_all$subgroup <- with(rr_table8_all, ifelse(Comparison=="Age < 65 At-risk vs Age < 65 Not at-risk", "Age < 65, Risk for Severe Covid-19", ifelse(Comparison=="Age >= 65 At-risk vs Age >= 65 Not at-risk", "Age >= 65, Risk for Severe Covid-19", subgroup)))

tab_rrdiff[] <- lapply(tab_rrdiff, as.character)
rr_table8_all[] <- lapply(rr_table8_all, as.character)

dim(rr_table8_all)==dim(tab_rrdiff)

rr_table8_all <- tab_rrdiff[, c("Comparison", "subgroup", "Baseline SARS-CoV-2", "Arm", "Visit", "Marker")] %>% 
  left_join(rr_table8_all, by=c("Comparison", "subgroup", "Baseline SARS-CoV-2", "Arm", "Visit", "Marker")
)

rr_table8_all <- rr_table8_all[, c("Comparison", "subgroup","Baseline SARS-CoV-2","Arm","Visit","Marker","% 4-Fold Rise", "% 2-Fold Rise","Responder")]

testthat::expect_equal(rr_table8_all, tab_rrdiff)

save(rr_table8_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table8.Rdata"))
```

\clearpage


## Table 9. Antibody levels in the baseline SARS-CoV-2 negative per-protocol cohort (vaccine vs. placebo)

```{r table9, results = "asis", echo=FALSE, message=FALSE, warning=FALSE}
fig_footer <- c("")

rr9_combine <- rr_table2_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Negative" & subgroup=="All participants") %>% select(-1,-2,-9,-10) %>%
  bind_rows(rr_table3_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Negative" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  #bind_rows(rr_table4_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Negative" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  left_join(
    rr_table5_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Negative" & subgroup=="All participants") %>% select(-1,-2) %>% rename_with(~ gsub("GMT/GMC","GMT",.x)),
            by=c("Visit","Arm","Baseline SARS-CoV-2","Marker","N")
    ) %>%
  pivot_wider(names_from=Arm, values_from=c(N,Responder, GMT)) %>%
  left_join(
    rr_table8_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Negative" & subgroup=="Arm") %>% select(-1,-2,-4,-7,-8) %>% rename_with(~ gsub("Responder","rrdiff",.x)),
            by=c("Visit","Baseline SARS-CoV-2","Marker")
    ) %>%
  rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
  select(1,2,3,4,6,8,5,7,9,10) 


ind=1
rr_table9_list=list()
for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
  for (tp in two_timepoints){

  rr9 <- subset(dat.long.stack, VarName == "All participants") %>%
    filter(Marker == mk & Visit == tp)
      
  design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr9), Baseline %in% c("Negative"))
  
  mod <- svyby(readout_trunc ~ Trt_lb, ~VarName+Visit+Baseline+Marker, design, svyglm, vartype="ci")
  
  res9 <- mod %>% 
    rowwise() %>%
    mutate(`Ratios of GMT`=paste0(decimal_f(10^`Trt_lbVaccine`,2),"\n(",decimal_f(10^ci_l.Trt_lbVaccine,2),", ",decimal_f(10^ci_u.Trt_lbVaccine,2),")")) %>%
    select(2,3,4,11)
  
  rr_table9 <- res9 %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    rename_with(~ gsub("Baseline","Baseline SARS-CoV-2",.x))
  
  rr_table9_list[[ind]] <- rr_table9

  ind=ind+1
  }
}

# comparison
rr_table9_all <- do.call("rbind", rr_table9_list)

rr_table9_all <- rr9_combine %>%
  left_join(rr_table9_all,
            by=c("Visit", "Baseline SARS-CoV-2", "Marker")) %>%
  select(-2)

dim(rr_table9_all)==dim(tab_neg)

tab_neg[] <- lapply(tab_neg, as.character)
rr_table9_all[] <- lapply(rr_table9_all, as.character)

rr_table9_all <- tab_neg[, c("Visit","Marker")] %>%
  left_join(rr_table9_all, by=c("Visit","Marker"))

testthat::expect_equal(rr_table9_all, tab_neg)

save(rr_table9_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table9.Rdata"))
```

\clearpage


## Table 10. Antibody levels in the baseline SARS-CoV-2 positive per-protocol cohort (vaccine vs. placebo)

```{r table10, results = "asis",  echo=FALSE, message=FALSE, warning=FALSE}
fig_footer <- c("")

rr10_combine <- rr_table2_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Positive" & subgroup=="All participants") %>% select(-1,-2,-9,-10) %>%
  bind_rows(rr_table3_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Positive" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  #bind_rows(rr_table4_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Positive" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  left_join(
    rr_table5_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Positive" & subgroup=="All participants") %>% select(-1,-2) %>% rename_with(~ gsub("GMT/GMC","GMT",.x)),
            by=c("Visit","Arm","Baseline SARS-CoV-2","Marker","N")
    ) %>%
  pivot_wider(names_from=Arm, values_from=c(N,Responder, GMT)) %>%
  left_join(
    rr_table8_all %>% ungroup() %>% filter(`Baseline SARS-CoV-2`=="Positive" & subgroup=="Arm") %>% select(-1,-2,-4,-7,-8) %>% rename_with(~ gsub("Responder","rrdiff",.x)),
            by=c("Visit","Baseline SARS-CoV-2","Marker")
    ) %>%
  rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
  select(1,2,3,4,6,8,5,7,9,10) 


ind=1
rr_table10_list=list()
for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
  for (tp in two_timepoints){

  rr10 <- subset(dat.long.stack, VarName == "All participants") %>%
    filter(Marker == mk & Visit == tp)
      
  design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr10), Baseline %in% c("Positive"))
  
  mod <- svyby(readout_trunc ~ Trt_lb, ~VarName+Visit+Baseline+Marker, design, svyglm, vartype="ci")
  
  res10 <- mod %>% 
    rowwise() %>%
    mutate(`Ratios of GMT`=paste0(decimal_f(10^`Trt_lbVaccine`,2),"\n(",decimal_f(10^ci_l.Trt_lbVaccine,2),", ",decimal_f(10^ci_u.Trt_lbVaccine,2),")")) %>%
    select(2,3,4,11)
  
  rr_table10 <- res10 %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    rename_with(~ gsub("Baseline","Baseline SARS-CoV-2",.x))
  
  rr_table10_list[[ind]] <- rr_table10

  ind=ind+1
  }
}

# comparison
rr_table10_all <- do.call("rbind", rr_table10_list)

rr_table10_all <- rr10_combine %>%
  left_join(rr_table10_all,
            by=c("Visit", "Baseline SARS-CoV-2", "Marker")) %>%
  select(-2)

dim(rr_table10_all)==dim(tab_pos)

tab_pos[] <- lapply(tab_pos, as.character)
rr_table10_all[] <- lapply(rr_table10_all, as.character)

rr_table10_all <- tab_neg[, c("Visit","Marker")] %>%
  left_join(rr_table10_all, by=c("Visit","Marker"))

testthat::expect_equal(rr_table10_all, tab_pos)

save(rr_table10_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table10.Rdata"))
```

\clearpage

## Table 11. Antibody levels in the per-protocol cohort (vaccine recipients)

```{r table11, results = "asis",  echo=FALSE, message=FALSE, warning=FALSE}
fig_footer <- c("")

rr11_combine <- rr_table2_all %>% ungroup() %>% filter(Arm=="Vaccine" & subgroup=="All participants") %>% select(-1,-2,-9,-10) %>%
  bind_rows(rr_table3_all %>% ungroup() %>% filter(Arm=="Vaccine" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  #bind_rows(rr_table4_all %>% ungroup() %>% filter(Arm=="Vaccine" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  left_join(
    rr_table5_all %>% ungroup() %>% filter(Arm=="Vaccine" & subgroup=="All participants") %>% select(-1,-2) %>% rename_with(~ gsub("GMT/GMC","GMT",.x)),
            by=c("Visit","Arm","Baseline SARS-CoV-2","Marker","N")
    ) %>%
  rename_with(~ gsub(" SARS-CoV-2","",.x)) %>%
  pivot_wider(names_from=Baseline, values_from=c(N, Responder, GMT)) %>%
  rename_with(~ gsub("GMT","GMT/GMC",.x))
  

# for response rate diff between positive and negative
ind=1
res11_ratediff_list=list()
for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
  for (tp in two_timepoints){

  rr11 <- subset(dat.long.stack, VarName == "All participants") %>%
    filter(Marker == mk & Visit == tp)
      
  design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr11), Trt_lb=="Vaccine")
  
  mod <- svyby(~response, ~Visit+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)

  res11_ratediff <- mod %>% 
    pivot_wider(names_from = Baseline, values_from = c(response:ci_u)) %>%
    rowwise() %>% 
    mutate(rrdiff=paste0(round((response_Positive-response_Negative)*100,1),
                               "%\n(", round((response_Positive-response_Negative-sqrt((response_Positive-ci_l_Positive)^2+(ci_u_Negative-response_Negative)^2))*100,1),"%, ", round((response_Positive-response_Negative+sqrt((response_Negative-ci_l_Negative)^2+(ci_u_Positive-response_Positive)^2))*100,1),"%)")) %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    select(Visit, Marker, rrdiff)
  
  res11_ratediff_list[[ind]] <- res11_ratediff 

  ind=ind+1
  }
}
res11_ratediff_all <- do.call("rbind", res11_ratediff_list)

# for magnitude ratio between positive and negative
ind=1
res11_magdiff_list=list()
for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
  for (tp in two_timepoints){

  rr11 <- subset(dat.long.stack, VarName == "All participants") %>%
    filter(Marker == mk & Visit == tp)
      
  design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr11), Trt_lb=="Vaccine")
  
  mod <- svyby(readout_trunc~Baseline, ~Visit+Marker, design, survey::svyglm, vartype="ci")

  res11_magdiff <- mod %>% 
    rowwise() %>% 
    mutate(`Ratios of GMT`=paste0(decimal_f(10^BaselinePositive,2),"\n(",decimal_f(10^ci_l.BaselinePositive,2),", ",decimal_f(10^ci_u.BaselinePositive,2),")")) %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    select(1,2,9)
  
  res11_magdiff_list[[ind]] <- res11_magdiff 

  ind=ind+1
  }
}
res11_magdiff_all <- do.call("rbind", res11_magdiff_list)

rr_table11_all <- rr11_combine %>%
  left_join(res11_ratediff_all, by=c("Visit","Marker")) %>%
  left_join(res11_magdiff_all, by=c("Visit","Marker")) %>%
  select(1,3,5,7,9,4,6,8,10,11)

# comparison
dim(rr_table11_all)==dim(tab_vacc)

tab_vacc[] <- lapply(tab_vacc, as.character)
rr_table11_all[] <- lapply(rr_table11_all, as.character)

rr_table11_all <- tab_vacc[, c("Visit","Marker")] %>%
  left_join(rr_table11_all, by=c("Visit","Marker"))

testthat::expect_equal(rr_table11_all, tab_vacc)

save(rr_table11_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table11.Rdata"))
```

\clearpage

## Table 12. Antibody levels in the per-protocol cohort (placebo recipients)

```{r table12, results = "asis", echo=FALSE, message=FALSE}
fig_footer <- c("")

rr12_combine <- rr_table2_all %>% ungroup() %>% filter(Arm=="Placebo" & subgroup=="All participants") %>% select(-1,-2,-9,-10) %>%
  bind_rows(rr_table3_all %>% ungroup() %>% filter(Arm=="Placebo" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  #bind_rows(rr_table4_all %>% ungroup() %>% filter(Arm=="Vaccine" & subgroup=="All participants") %>% select(-1,-2,-9,-10)) %>%
  left_join(
    rr_table5_all %>% ungroup() %>% filter(Arm=="Placebo" & subgroup=="All participants") %>% select(-1,-2) %>% rename_with(~ gsub("GMT/GMC","GMT",.x)),
            by=c("Visit","Arm","Baseline SARS-CoV-2","Marker","N")
    ) %>%
  rename_with(~ gsub(" SARS-CoV-2","",.x)) %>%
  pivot_wider(names_from=Baseline, values_from=c(N, Responder, GMT)) %>%
  rename_with(~ gsub("GMT","GMT/GMC",.x))
  

# for response rate diff between positive and negative
ind=1
res12_ratediff_list=list()
for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
  for (tp in two_timepoints){

  rr12 <- subset(dat.long.stack, VarName == "All participants") %>%
    filter(Marker == mk & Visit == tp)
      
  design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr12), Trt_lb=="Placebo")
  
  mod <- svyby(~response, ~Visit+Baseline+Marker, design, survey::svyciprop, ci=TRUE, vartype="ci", na.rm=T)

  res12_ratediff <- mod %>% 
    pivot_wider(names_from = Baseline, values_from = c(response:ci_u)) %>%
    rowwise() %>% 
    mutate(rrdiff=paste0(round((response_Positive-response_Negative)*100,1),
                               "%\n(", round((response_Positive-response_Negative-sqrt((response_Positive-ci_l_Positive)^2+(ci_u_Negative-response_Negative)^2))*100,1),"%, ", round((response_Positive-response_Negative+sqrt((response_Negative-ci_l_Negative)^2+(ci_u_Positive-response_Positive)^2))*100,1),"%)")) %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    select(Visit, Marker, rrdiff)
  
  res12_ratediff_list[[ind]] <- res12_ratediff 

  ind=ind+1
  }
}
res12_ratediff_all <- do.call("rbind", res12_ratediff_list)

# for magnitude ratio between positive and negative
ind=1
res12_magdiff_list=list()
for (mk in c("Anti N IgG (IU/ml)","Anti RBD IgG (IU/ml)","Anti Spike IgG (IU/ml)","Pseudovirus-nAb ID50","Pseudovirus-nAb ID80")){
  for (tp in two_timepoints){

  rr12 <- subset(dat.long.stack, VarName == "All participants") %>%
    filter(Marker == mk & Visit == tp)
      
  design <- subset(twophase(id = list(~Ptid, ~ Ptid), strata = list(NULL, ~ tps.stratum), weights = list(NULL, ~ wt.subcohort), subset=~immuno_ind, method="simple", data = rr12), Trt_lb=="Placebo")
  
  mod <- svyby(readout_trunc~Baseline, ~Visit+Marker, design, survey::svyglm, vartype="ci")

  res12_magdiff <- mod %>% 
    rowwise() %>% 
    mutate(`Ratios of GMT`=paste0(decimal_f(10^BaselinePositive,2),"\n(",decimal_f(10^ci_l.BaselinePositive,2),", ",decimal_f(10^ci_u.BaselinePositive,2),")")) %>%
    rename_with(~ gsub("GMT","GMT/GMC",.x)) %>%
    select(1,2,9)
  
  res12_magdiff_list[[ind]] <- res12_magdiff 

  ind=ind+1
  }
}
res12_magdiff_all <- do.call("rbind", res12_magdiff_list)

rr_table12_all <- rr12_combine %>%
  left_join(res12_ratediff_all, by=c("Visit","Marker")) %>%
  left_join(res12_magdiff_all, by=c("Visit","Marker")) %>%
  select(1,3,5,7,9,4,6,8,10,11)

# comparison
dim(rr_table12_all)==dim(tab_plcb)

tab_plcb[] <- lapply(tab_plcb, as.character)
rr_table11_all[] <- lapply(rr_table11_all, as.character)

rr_table12_all <- tab_plcb[, c("Visit","Marker")] %>%
  left_join(rr_table12_all, by=c("Visit","Marker"))

testthat::expect_equal(rr_table12_all, tab_plcb)

save(rr_table12_all,
    file = here::here("verification", "verification_output", "immuno_tabular_verification_output_table12.Rdata"))
```
