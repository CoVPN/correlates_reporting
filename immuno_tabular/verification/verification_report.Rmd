---
title: "Verification Report: immuno_tabular"
author: "Yiwen Lu"
date: "2021/04/17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(testthat)
library(here)
```

```{r helper-functions, include=FALSE}
quiet<-function(x,func,...){
  x2<-try(suppressWarnings(func(x,...)),silent = TRUE)
  if(inherits(x2,'try-error')){
    return(x)
  }else{
    return(x2)
  }
}
naturalize <- function(x, round_digits = NA){
  NAs <- sum(is.na(x)| x=="NaN")
  date_formats<-c("%Y/%m/%d","%Y-%m-%d","%d-%b-%Y")
  if(sum(is.na(quiet(x,as.numeric))) == NAs){
    x <- quiet(x,as.numeric)
    if(!is.na(round_digits)){
      x <- round(x,round_digits)
    }
    return(x)
  }else if(sum(is.na(quiet(x,as.Date,tryFormats = date_formats))) == NAs){
    return(quiet(x,as.Date,tryFormats = date_formats))
  }else{
    return(x)
  }
}
# Equal test to include NA comparisons as T/F
equal <- function(x1,x2, threshold){
  
  if (is.numeric(x1) & threshold != 0) {
    x1 <- abs(x1 - x2) <= (threshold * (abs(x1 + x2)/2))
    x2 <- rep(TRUE,length(x1))
  }
  
  c <- as.character(x1) == as.character(x2)
  c[ is.na(x1) | is.na(x2) ] <- (is.na(x1) == is.na(x2) )[ is.na(x1) | is.na(x2) ]
  c
  
}
compare_datasets <- function(cols,ds1,ds2,index, verbose = TRUE, round_digits = NA, thresholds = 0){
  res <- lapply(cols,function(column_name){
    
    if(is.list(round_digits)){
      if(column_name %in% names(round_digits)){
        round_digit <- round_digits[[column_name]]
      }else{
        round_digit <- round_digits[[".default"]]
      }
    }else{
      round_digit <- round_digits
    }
    
    if(is.list(thresholds)){
      if(column_name %in% names(thresholds)){
        threshold <- thresholds[[column_name]]
      }else{
        threshold <- thresholds[[".default"]]
      }
    }else{
      threshold <- thresholds
    }
    
    
    
    v1 <- naturalize( ds1[ order( ds1[[index]] ), column_name, drop = TRUE], round_digits = round_digit)
    v2 <- naturalize( ds2[ order( ds2[[index]] ), column_name, drop = TRUE], round_digits = round_digit)
    is_equal <- equal( v1, v2 , threshold = threshold)
    if ( !all( is_equal ) & verbose)
      print( paste0("`", column_name, "` is not equal. ", sum(!is_equal),"/", max(length(v1),length(v2)), " mismatches." ) )
    
    
    
    return( list(
      equal = all( is_equal ),
      diffs = data.frame(
        key = sort(ds1[[index]])[!is_equal],
        ds1 = v1[!is_equal],
        ds2 = v2[!is_equal],
        stringsAsFactors = FALSE
        ))
      )
  })
  
  names(res) <- cols
  
  resmatched <- do.call( 'c', lapply(res,`[[`,1))
  if( verbose ){
    message( "There are ", sum(!resmatched), " mismatched fields of ", length(resmatched),'.')
  }
  
  attr(res,"index") <- index
  
  class(res) <- "comparison"
  return( res )
}
print.comparison <- function(x,...){
  n_mismatch <- do.call('c',lapply(x,function(y){
    z <- nrow(y$diffs)
    if(z>0){
      z
    }else{
      NULL
    }
  }))
  
  for(comp in names(n_mismatch)){
      message( paste0("`", comp, "` is not equal. ", n_mismatch[[comp]], " mismatches." ) )
  }
}
rerun_failed_comparisons <- function( x, ds1, ds2){
  mismatched <- names(do.call('c',lapply(x,function(y){
    if(nrow(y$diffs)>0){
      1
    }else{
      NULL
    }
  })))
  compare_datasets(mismatched, ds1, ds2, index = attr(x,"index"))
}
reformat <- function(x, digits = 1){
  format(round(as.numeric(x),digits = digits), nsmall = digits)
}
```

## Description

This is the verification report for the `immuno_tabular` folder of the `correlates_reporting` project for CoVPN. 

In this document, the output of `make_table_all.R` is compared against the output of `immuno_table_verification.Rmd`. The two scripts use the same base mock data. The two datasets generated by each of the two scripts will be compared with each other to confirm they contain the same values.

`immuno_table_verification.Rmd` was independently double programmed based on the specifications found in `table_specifications.pdf`. This script outputs its processing to \newline `verification/verification_output/immuno_tabular_verification_output_tables1.Rdata`, `verification/verification_output/immuno_tabular_verification_output_table2.Rdata`, `verification/verification_output/immuno_tabular_verification_output_table3.Rdata`, `verification/verification_output/immuno_tabular_verification_output_table5.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table6.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table7.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table8.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table9.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table10.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table11.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table12.Rdata`.

The file `verification/verification_input/practice_data.csv` and `verification/verification_input/Tables_verificatiton_immuno.Rdata` were provided by the original programmer to the tester for verification purposes of `make_table_all.R` when all time points are available.s
Their md5 hash are `r digest::digest(file = here("verification/verification_input","practice_data.csv"))`, `r digest::digest(file = here("verification/verification_input","Tables_verificatiton_immuno.Rdata"))`.

The file `verification/verification_output/immuno_tabular_verification_output_tables1.Rdata`, `verification/verification_output/immuno_tabular_verification_output_table2.Rdata`, `verification/verification_output/immuno_tabular_verification_output_table3.Rdata`, `verification/verification_output/immuno_tabular_verification_output_table5.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table6.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table7.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table8.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table9.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table10.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table11.Rdata`,
`verification/verification_output/immuno_tabular_verification_output_table12.Rdata` were created by the tester for verification using the `immuno_table_verification.Rmd` script and using all time points available.
Their md5 hash are `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_tables1.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table2.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table3.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table5.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table6.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table7.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table8.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table9.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table10.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table11.Rdata"))`, `r digest::digest(file = here("verification/verification_output/immuno_tabular_verification_output_table12.Rdata"))`.

### Load Data

```{r Load-Data, message=FALSE}
original_data <- load(
  here("verification","verification_input","Tables_verificatiton_immuno.Rdata")
  )
verification_data1 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_tables1.Rdata")
  )
verification_data2<- load(
  here("verification","verification_output","immuno_tabular_verification_output_table2.Rdata")
  )
verification_data3 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table3.Rdata")
  )
verification_data5 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table5.Rdata")
  )
verification_data6 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table6.Rdata")
  )
verification_data7 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table7.Rdata")
  )
verification_data8 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table8.Rdata")
  )
verification_data9<- load(
  here("verification","verification_output","immuno_tabular_verification_output_table9.Rdata")
  )
verification_data10 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table10.Rdata")
  )
verification_data11 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table11.Rdata")
  )
verification_data12 <- load(
  here("verification","verification_output","immuno_tabular_verification_output_table12.Rdata")
  )
```

## Verification

```{r comparison-full}
tab_dm_neg[] <- lapply(tab_dm_neg, as.character)
testthat::expect_equal(rr_table1.1, tab_dm_neg)

tab_dm_pos[] <- lapply(tab_dm_pos, as.character)
testthat::expect_equal(rr_table1.2, tab_dm_pos)

tab_bind[] <- lapply(tab_bind, as.character)
testthat::expect_equal(tab_bind, rr_table2_all)

tab_pseudo[] <- lapply(tab_pseudo, as.character)
testthat::expect_equal(tab_pseudo, rr_table3_all_sub)

tab_gm[] <- lapply(tab_gm, as.character)
testthat::expect_equal(tab_gm, rr_table5_all)

tab_gmr[] <- lapply(tab_gmr, as.character)
testthat::expect_equal(tab_gmr, rr_table6_all)

tab_rgmt[] <- lapply(tab_rgmt, as.character)
testthat::expect_equal(tab_rgmt, rr_table7_all)

tab_rrdiff[] <- lapply(tab_rrdiff, as.character)
testthat::expect_equal(tab_rrdiff, rr_table8_all)

tab_neg[] <- lapply(tab_neg, as.character)
testthat::expect_equal(tab_neg, rr_table9_all)

tab_pos[] <- lapply(tab_pos, as.character)
testthat::expect_equal(tab_pos, rr_table10_all)

tab_vacc[] <- lapply(tab_vacc, as.character)
testthat::expect_equal(tab_vacc, rr_table11_all)

tab_plcb[] <- lapply(tab_plcb, as.character)
testthat::expect_equal(tab_plcb, rr_table12_all)
```


## Signatures

```{r echo = FALSE, message = FALSE, tidy = FALSE, cache = FALSE, results = 'asis'}
suppressWarnings({
suppressPackageStartupMessages({
library(knitr)
library(kableExtra)
library(tibble)
})})
options(kableExtra.latex.load_packages = FALSE, 
        knitr.table.format = "latex",
        knitr.kable.NA = '',
        width = 40,
        usethis.quiet = TRUE)
signature_table <- function(people){
  # check that the tables have correct variables
  if (!all(c("role", "name") %in% tolower(names(people)))) {
    stop(paste0("people table must have variables: role and name. ",
                "Contains: ", paste0(tolower(names(people)), collapse = ", ")))
  }
  
  people$signature <- NA
  people$date <- NA
  names(people) <- tolower(names(people))
  people[, c("role", "name", "signature", "date")] %>% 
  kable(col.names = c("Role", "Name", "Signature", "Date"),
        escape = FALSE, booktabs = FALSE) %>% 
    kable_styling(full_width = FALSE, position = "left") %>% 
    row_spec(0, background = rgb(184, 204, 228, maxColorValue = 255)) %>% 
    column_spec(1, width = "9em", border_left = TRUE) %>% 
    column_spec(2, width = "11em") %>% 
    column_spec(3, width = "15em") %>% 
    column_spec(4, width = "8em", border_right = TRUE)
}
tibble::tribble(
  ~ name,                ~ role,
  "Yiwen Lu",  "Tester"
) %>% 
  signature_table()
```