#  Tabular Description of Immunogenicity Data {#immuno-tabular}

```{r knitr, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
here::i_am("immuno_tabular/report.Rmd")
base::load(here::here( "immuno_tabular", "output", "Tables.Rdata"))
source(here::here("immuno_tabular", "code", "make_functions.R"))
# Determine output document type.
doctype <- "html"
```

```{r tabs, results="asis", echo=FALSE, message=FALSE, warning=FALSE}
opts <- options(knitr.kable.NA = "")
for (i in 1:length(tlf)){
  subnum <- 0
  tlf_labels <- tlf[[i]]

  title_i <- tlf_labels[["table_header"]]
  footer_i <- tlf_labels[["table_footer"]]
  tlf_args <- names(tlf_labels)
  
  tab <- get(names(tlf)[i])
  
  deselect <- if ("deselect" %in% tlf_args) tlf_labels[["deselect"]] else NA
  loop <- if ("loop" %in% tlf_args) tlf_labels[["loop"]] else NA
  group_table_col <- if ("group_table_col" %in% tlf_args) {
    tlf_labels[["group_table_col"]] 
    } else NA 
  
  if ("pack_row" %in% tlf_args) {
    pack_row <- tlf_labels[["pack_row"]]
    if (!is.na(loop)) { 
      pack_row_ind <- by(tab, 
                         tab[, loop], 
                         function(x)table(droplevels(x[, pack_row])))
      } else {
      pack_row_ind <- table(droplevels(tab[, pack_row]))  
      }
    } else NA
  
  col_name <- if ("col_name" %in% tlf_args) { 
    tlf_labels[["col_name"]] 
  } else setdiff(names(tab), deselect) 
  
  header_above1 <- if ("header_above1" %in% tlf_args) {
    tlf_labels[["header_above1"]] 
    } else {
    rep("", ncol(tab)-!is.na(deselect))
    }
  
  header_above2 <- if ("header_above2" %in% tlf_args) {
    tlf_labels[["header_above2"]] 
    } else {
    rep("", ncol(tab)-!is.na(deselect))
    }
  
  tab<- data.frame(sapply(tab, gsub, pattern="\n", replacement="<br>", fixed=T))
  
  if (!is.na(loop)) {
    
    jloop <- pull(tab, !!as.name(loop)) %>% unique()
    
    for (j in jloop) {
      subnum <- subnum + 1
      tab.j <- dplyr::filter(tab, !!as.name(loop) == j) 
      # if (!is.na(group_table_col)) {
      #   tab.j <- mutate_at(tab.j, group_table_col, as.character)
      #   tab.j <- group_table(data.frame(tab.j), group_table_col)
      #   }
        
      tabjk <- kable(tab.j %>% select(-!!deselect),
                     format = "html",
                     booktabs = TRUE, longtable = TRUE, escape = FALSE,
                     col.names = col_name, 
                     caption = sprintf("Table %s%s. %s by %s", i,
                                       letters[subnum], title_i, j)) %>%
        add_header_above(header_above1) %>%
        add_header_above(header_above2) %>%
        kable_styling(latex_options = "repeat_header") %>%
        footnote(general_title = "", general = footer_i, threeparttable = TRUE, 
                 escape = FALSE)
      
      if ("pack_row" %in% tlf_args) {
        tabjk <- pack_rows(tabjk, index = pack_row_ind[j])
        }
    print(tabjk)
    cat("\n\n\\pagebreak\n")
    }
    
    } else {

      tabk <- kable(
        if (is.na(deselect)) {tab} else {tab %>% select(-!!deselect)},
        format = "html", booktabs = TRUE, longtable = TRUE, escape = FALSE,
        col.names = col_name, 
        caption = sprintf("Table %s. %s", i, title_i)) %>%
        kable_styling(latex_options = "repeat_header") %>% 
        add_header_above(header_above1) %>%
        add_header_above(header_above2) %>%
        footnote(general_title = "", general = footer_i, 
                 threeparttable = TRUE, escape = FALSE)
      
      if ("pack_row" %in% tlf_args) {
        tabk <- pack_rows(tabk, index = pack_row_ind)
        }
      print(tabk)
      cat("\n\n\\pagebreak\n")
}

}

```
