---
title: "Key statistics for the verification of immunogenicity plots"
author: "Kendrick Li"
date: "3/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Load the libraries and datasets

```{r load_lib_dat, warning = FALSE, message = FALSE}
library(here)
library(spatstat)
library(dplyr)

source(here::here("..", "_common.R"))
source(here("code", "params.R"))

dat.long.twophase.sample <- readRDS(here(
  "data_clean",
  "long_twophase_data.rds"
))
dat.twophase.sample <- readRDS(here("data_clean", "twophase_data.rds"))

```
## Plot 1.3; Pair plots of D57 Ab markers: baseline negative vaccine arm 
*Pairwise resampling-based stratified Spearman correlation*
(Since the calculation is resampling based, the specific numbers could be different depending on the code and the random seeds).

- RBD IgG vs. Spike IgG: 0.426

- PsV-nAb ID50 vs. Spike IgG: 0.379

- PsV-nAb ID80 vs. Spike IgG: 0.375

- PsV-nAb ID50 vs. RBD IgG: 0.335

- PsV-nAb ID80 vs. RBD IgG: 0.378

- PSV-nAb ID80 vs. PsV-nAb ID50: 0.493

## Plot 1.24; RCDF plots for D57 Ab markers: by baseline status for the vaccine arm
*Weighted RCDF for four assays, stratified by baseline status, evaluated at 1-10*

```{r wrcdf_by_bstatus}
for (bstatus in 1:2) {
  cat(bstatus.labels[bstatus], "\n")
  for (aa in 1:4) {
    cat(aa, ". ", labels.assays[aa], "\n")
    
    subdat <- dat.long.twophase.sample %>%
      filter(assay == assays[aa], Bserostatus == bstatus.labels[bstatus],
             Trt == "Vaccine") %>%
      select(Day57, wt.subcohort) %>%
      filter(complete.cases(.))
    
    ecdf_res <- with(subdat, ewcdf(Day57, wt.subcohort))
    
    print(data.frame(x = 1:10, wrcdf = 1 - ecdf_res(1:10)))
  }
}


```
## Plot 1.32; Boxplots of D57 Ab markers: baseline negative vaccine + placebo arms (boxplots_Day57_x_trt_BaselineNeg_mock.png)

*Minimum and maximum, quartiles, and mean*

```{r verify_boxplots}
for (trt in 1:2) {
  cat("Baseline Negative", trt.labels[trt], "Arm:\n")
  
  for (aa in 1:4) {
    cat(aa, ". ", labels.assays[aa], "\n")
    
    subdat <- dat.long.twophase.sample %>%
      filter(assay == assays[aa], Bserostatus == "Baseline Neg",
             Trt == trt.labels[trt]) %>%
      select(Day57) %>%
      filter(complete.cases(.))
    
    print(summary(subdat$Day57))
  }
}
```

## Plot 1.47; Spaghetti plots of Ab markers over time: baseline negative vaccine + placebo arm (Spaghetti_plot_BaselineNeg_mock.png)
*Since the sample points in the spaghetti plots are randomly selected, I suggest verifying the key statistics of D1, D29, and D57 readouts by treatment group*
```{r verify_sphaghetti}
for (trt in 1:2) {
  for (aa in 1:4) {
    cat("Baseline Negative", trt.labels[trt], "\n")
    cat(unlist(labels.assays.short[aa]), ":\n", sep = "")
    subdat <- filter(dat.long.twophase.sample, 
                     assay == assays[aa],
                     Bserostatus == "Baseline Neg",
                     Trt == trt.labels[trt])
    
    cat("D1:\n")
    print(summary(subdat$B))
    cat("D29:\n")
    print(summary(subdat$Day29))
    cat("D57:\n")
    print(summary(subdat$Day57))
  }
}


```