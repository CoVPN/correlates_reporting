---
title: "Key statistics for the verification of immunogenicity plots"
author: "Kendrick Li"
date: "4/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Load the libraries and datasets

```{r load_lib_dat, warning = FALSE, message = FALSE}
library(here)
library(spatstat.geom)
library(dplyr)

source(here::here("..", "_common.R"))
source(here("code", "params.R"))

dat.long.twophase.sample <- readRDS(here(
  "data_clean",
  "long_twophase_data.rds"
))
dat.twophase.sample <- readRDS(here("data_clean", "twophase_data.rds"))

```
## Plot 1.3; Pair plots of D57 Ab markers: baseline negative vaccine arm 
*Pairwise resampling-based stratified Spearman correlation*
(Since the calculation is resampling based, the specific numbers could be different depending on the code and the random seeds).

- RBD IgG vs. Spike IgG: 0.567

- PsV-nAb ID50 vs. Spike IgG: 0.488

- PsV-nAb ID80 vs. Spike IgG: 0.516

- PsV-nAb ID50 vs. RBD IgG: 0.463

- PsV-nAb ID80 vs. RBD IgG: 0.505

- PSV-nAb ID80 vs. PsV-nAb ID50: 0.542

## Plot 1.24; RCDF plots for D57 Ab markers: by baseline status for the vaccine arm
*Weighted RCDF for four assays, stratified by baseline status, evaluated at 1-10*

```{r wrcdf_by_bstatus}
for (bstatus in 1:2) {
  cat(bstatus.labels[bstatus], "\n")
  for (aa in 1:4) {
    cat(aa, ". ", labels.assays[aa], "\n")
    
    subdat <- dat.long.twophase.sample %>%
      filter(assay == assays[aa], Bserostatus == bstatus.labels[bstatus],
             Trt == "Vaccine") %>%
      select(Day57, wt.subcohort) %>%
      filter(complete.cases(.))
    
    ecdf_res <- with(subdat, ewcdf(Day57, wt.subcohort))
    eval_matrix <- data.frame(x = 1:10, wrcdf = 1 - ecdf_res(1:10))
    write.csv(eval_matrix, sprintf("day57_wrcdf_rcdf_plots_bstatus_%s_%s.csv",
                                   bstatus.labels.2[bstatus],
                                   assays[aa]), row.names = FALSE)
    print(eval_matrix)
  }
}


```
## Plot 1.32; Boxplots of D57 Ab markers: baseline negative vaccine + placebo arms (boxplots_Day57_x_trt_BaselineNeg_mock.png)

*Minimum and maximum, quartiles, and mean*

```{r verify_boxplots}
for (trt in 1:2) {
  cat("Baseline Negative", trt.labels[trt], "Arm:\n")
  
  for (aa in 1:4) {
    cat(aa, ". ", labels.assays[aa], "\n")
    
    subdat <- dat.long.twophase.sample %>%
      filter(assay == assays[aa], Bserostatus == "Baseline Neg",
             Trt == trt.labels[trt]) %>%
      select(Day57) %>%
      filter(complete.cases(.))
    print(summary(subdat$Day57))
    
    day57_sum <- summary(subdat$Day57) 
    day57_sum_mat <- data.frame(summary = attr(day57_sum, "names"),
                                value = as.numeric(day57_sum))
    write.csv(day57_sum_mat, sprintf("boxplots_day57_summary_trt_%s_%s.csv", trt.labels[trt], assays[aa]), row.names = FALSE)
  }
}
```

## Plot 1.47; Spaghetti plots of Ab markers over time: baseline negative vaccine + placebo arm (Spaghetti_plot_BaselineNeg_mock.png)
*Since the sample points in the spaghetti plots are randomly selected, I suggest verifying the key statistics of D1, D29, and D57 readouts by treatment group*
```{r verify_sphaghetti}
for (trt in 1:2) {
  for (aa in 1:4) {
    cat("Baseline Negative", trt.labels[trt], "\n")
    cat(unlist(labels.assays.short[aa]), ":\n", sep = "")
    subdat <- filter(dat.long.twophase.sample, 
                     assay == assays[aa],
                     Bserostatus == "Baseline Neg",
                     Trt == trt.labels[trt])
    
    sum_B <- summary(subdat$B)
    sum_B_mat <- data.frame(summary = attr(sum_B, "names"),
                            value = as.numeric(sum_B))
    write.csv(sum_B_mat, sprintf("spaghetti_plots_summary_B_trt_%s_%s.csv", trt.labels[trt], assays[aa]),
              row.names = FALSE)
    
    sum_day29 <- summary(subdat$Day29)
    sum_day29_mat <- data.frame(summary = attr(sum_day29, "names"),
                                value = as.numeric(sum_day29))
    write.csv(sum_day29_mat, sprintf("spaghetti_plots_summary_day29_trt_%s_%s.csv", trt.labels[trt], assays[aa]),
              row.names = FALSE)
    
    sum_day57 <- summary(subdat$Day57)
    sum_day57_mat <- data.frame(summary = attr(sum_day57, "names"),
                                value = as.numeric(sum_day57))
    write.csv(sum_day57_mat, sprintf("spaghetti_plots_summary_day57_trt_%s_%s.csv", trt.labels[trt], assays[aa]),
              row.names = FALSE)
     
    cat("D1:\n")
    print(summary(subdat$B))
    cat("D29:\n")
    print(summary(subdat$Day29))
    cat("D57:\n")
    print(summary(subdat$Day57))
  }
}


```